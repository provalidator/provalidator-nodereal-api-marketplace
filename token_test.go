package main

import (
	"io/ioutil"
	"strings"
	"testing"

	"github.com/golang-jwt/jwt"
	"github.com/provalidator-nodereal-api-marketplace/log"
)

func TestVerify(t *testing.T) {
	// logger Init
	log.LogInit()

	// Get public key
	byteKey, _ := ioutil.ReadFile("./keys/nodereal.pub")
	parsedPubKey, _ = jwt.ParseRSAPublicKeyFromPEM(byteKey)

	// Invalid token
	//eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNjcxOTQ0ODg0LCJpYXQiOjE2NzE5NDQ1ODQsImp0aSI6ImY1OTlhZmEyMTQxZTQzNGRiMTIwZWEzZjVlNTRhZjRmIiwidXNlcl9pZCI6MX0.RvVngAsvI20vB8tXfewzZbIZ9LDc9FJW9twraTbRBjgZx6_W6rKipirumr9Zf5R3rJpUmZwLKqtcbXs7eb282yvq7GG3W5-zlI1eVnwEWCIYHx5yAVwUFlX2qUPe1e2Vscg_b8mVRSHBJUsvLf_tHQ9d5Wvd4rnfOpsZUHdvbc3HxsxPeMul1iPi57CJ54Tb98nt6TZqWE0tuz4j5UyUgvmZ7mkYksSz4_qEQrlnpYGJAaLdpk3qJPbxcf6a-EuQlfOxOhZj_RKdtEEp0E7u7LmxFCVooG5rbdOlfHO1yJ4BAxqvCjTYt9Rg89UkU44lF506iED1Lb_gdAvE92vkHqm7yHCytmU4u6LLbwrInko9Lh4tKOHVSLreXBv39ZR_qN0eOtQJq-cAf8_5FTL0EFqvaD8LUhvoAe81uiIIyeUBP0hxnGEQL04I_kqH_PVJB9o9gUXp8RATbkphone4cxZ-M2VSK1XFShgy9Mx3tDPX-aj-O4OQvw6SQHRHbJk8vviO-JhDx9TI2xzcB0t0tCw1som8ZekLO4pMgsNivkUrYuKDc_MyjWDqerAWf5EE0hZlTyzhLB3zXuxwZvnFOa55WxedOSsQlMQjY-6kBfYAwv5epjjo35-aCTOXQ3yaR6b5fr7geK_vTy9KDW_UCF6i_o8oUIcLaEwnsG9b6p8

	// Valid token
	//eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2ODM3MzQzOTksImlzcyI6Ik5vZGVSZWFsIiwic2NvcGUiOiJGcmVlIiwic3ViIjoiZDU4MTU1ZTktNDViZi00MzJiLWI5MjctYzhjYTg3MTcwY2ExIn0.YZVa4H_2VrA0weta03GdOKH4dIM_2vSBIAJfR9UPfSmFv_lisH8sctcJ3rUgwrYrcmJQBPJW44lREej9EumUhqUyVRBuBO9WMF6_NTMPotqExGupfMCSxfFll18rwYhviK7xUj-RkWmW1bePsY3kq0izKn-QAuRoP4lgjNJunEPJHcKGOA9JMLfKxITwl2wNGr1zQ7py1AlHn_sbFBbHW5R0mYR2kOSPmGk_3mzvaFz1hDHFt5O5N-3T8hung669Vjma7YHygtxeqols6RWwQJlMXwku0ki6xw7du-gfqTnS2ooe8csTDSmVRp1u3stsGYU_8U5UM8JmluFEDuMSX25_ZcnUYRehtogFyGIkWZcdt7NJ_OhAl6VYQVmZe458WoM5a968m97tabBRHOcwMmDx7CemcfEpN6Pnwl8k-8Q-uGQs7CjdXr1tJV44km_H44Ni3B7anyo7U9qt6ejHB4hpaPviyftGjyvZz18Vhaqh_DG7Ezn6lIiGEFuGyI2ibZi5z_jxGt4QN0P-zsYuThm81x6eZF30bpESq3n6D1WicKzoDXVf1KBM7IOyuF6dvztfhFf3UTqxS5zSzN6pdS36kH6W1SGyIGJ1kNzeBWEa-iJx7R_7cpyqsdOBSG3JJC8e6To_ZFBVuCKYwuCFUanabClF06ajXcwpqm0Hlhw

	// Expired Token
	//eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2ODAyNzgzOTksImlzcyI6Ik5vZGVSZWFsIiwic2NvcGUiOiJGcmVlIiwic3ViIjoiZDU4MTU1ZTktNDViZi00MzJiLWI5MjctYzhjYTg3MTcwY2ExIn0.GeEjkD7SP6qx_HLMu7SkVi2qLktsvZk55IYCQODIHv638x2-rRWjPmZx-o1NSSpKgTuoOrm0AKyrfzZwqqLf5dnooFlJBA9gOJWWBXDlT2YUt2j6u1ufLBVmOgAjrFSQJhRVNCeEaCnFSalPOwDbF2JAH7ufWia90tGEowQWnKVMqRyfKzpR0qnu9Er_uq56ElDCuzD0EtRlXz6pHDdu1FbLfWJyOK3nHcV09yDasFxu7ERi9_iq-S0uJkzFmJ-N0XFhbqAyjSFFZKBhR10vlDkjfQ63w0HpbvxwxVpKcJndcod8AZJmKUa8UJPQMYngEzxzTv_b6R5weJIlEeim14yBpa8CVBBz0EgENY-BFBfOOCXEhQApFr_OMhd43qbL6H2AUVfpFiLGOFizTvY9uKBGQQwQToBZ-YTzlOcS_e_9ju8uKZ5G3YziFc3-7g5E1IYNTM_KFDD4HMiIST_o1kRhT6L0O4UNwRWnHmi_3PpCUckkDa7g0LsHjlXnrgjjm4FGtByYsVDU-jv0AlsVvzzqLMjlSMUPqSLftWb_MnR5T-c7LoxbJ_t-sGCZpCukDzLNaqvuOQigTG7OYvf_OCUOUrtU62EVASTsKv5KvblcMHjQs2lA9VOfP78lDvegAGP9ZVAGInU5GFvEr6OAbSd3H5W5ulfLPYsrYsTpWM0
	tokenString := "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2ODAyNzgzOTksImlzcyI6Ik5vZGVSZWFsIiwic2NvcGUiOiJGcmVlIiwic3ViIjoiZDU4MTU1ZTktNDViZi00MzJiLWI5MjctYzhjYTg3MTcwY2ExIn0.GeEjkD7SP6qx_HLMu7SkVi2qLktsvZk55IYCQODIHv638x2-rRWjPmZx-o1NSSpKgTuoOrm0AKyrfzZwqqLf5dnooFlJBA9gOJWWBXDlT2YUt2j6u1ufLBVmOgAjrFSQJhRVNCeEaCnFSalPOwDbF2JAH7ufWia90tGEowQWnKVMqRyfKzpR0qnu9Er_uq56ElDCuzD0EtRlXz6pHDdu1FbLfWJyOK3nHcV09yDasFxu7ERi9_iq-S0uJkzFmJ-N0XFhbqAyjSFFZKBhR10vlDkjfQ63w0HpbvxwxVpKcJndcod8AZJmKUa8UJPQMYngEzxzTv_b6R5weJIlEeim14yBpa8CVBBz0EgENY-BFBfOOCXEhQApFr_OMhd43qbL6H2AUVfpFiLGOFizTvY9uKBGQQwQToBZ-YTzlOcS_e_9ju8uKZ5G3YziFc3-7g5E1IYNTM_KFDD4HMiIST_o1kRhT6L0O4UNwRWnHmi_3PpCUckkDa7g0LsHjlXnrgjjm4FGtByYsVDU-jv0AlsVvzzqLMjlSMUPqSLftWb_MnR5T-c7LoxbJ_t-sGCZpCukDzLNaqvuOQigTG7OYvf_OCUOUrtU62EVASTsKv5KvblcMHjQs2lA9VOfP78lDvegAGP9ZVAGInU5GFvEr6OAbSd3H5W5ulfLPYsrYsTpWM0"
	parts := strings.Split(tokenString, ".")
	method := jwt.GetSigningMethod("RS256")
	err := method.Verify(strings.Join(parts[0:2], "."), parts[2], parsedPubKey)
	// err := jwt.SigningMethodRS256.Verify(strings.Join(parts[0:2], "."), parts[2], parsedKey)
	if err != nil {
		log.Logger.Info.Println("Verifying key fail")
	}
	log.Logger.Info.Println("Verifying key success")
}
